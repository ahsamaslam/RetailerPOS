@page
@model Retailer.POS.Web.Pages.Sales.CreateModel
@{
    ViewData["Title"] = "Create Sale";
}

<h2>Create Sale</h2>

<form method="post" id="saleForm">
    <div class="row">
        <div class="col-md-4 mb-2">
            <label>Date</label>
            <input asp-for="Sale.Date" type="date" class="form-control" />
        </div>
        <div class="col-md-4 mb-2">
            <label>Branch Id</label>
            <input asp-for="Sale.BranchId" type="number" class="form-control" />
        </div>
        <div class="col-md-4 mb-2">
            <label>Login Id</label>
            <input asp-for="Sale.LoginId" type="number" class="form-control" />
        </div>
    </div>

    <div class="mb-2">
        <label>Customer</label>
        <input asp-for="Sale.CustomerName" class="form-control" />
    </div>

    <h4>Items</h4>
    <table class="table" id="detailsTable">
        <thead>
            <tr>
                <th>Item Code</th>
                <th>Item Name</th>
                <th>Rate</th>
                <th>Qty</th>
                <th>Discount</th>
                <th>Tax %</th>
                <th>Amount</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < Model.Sale.Details.Count; i++)
            {
                <tr data-index="@i">
                    <td><input asp-for="Sale.Details[i].ItemCode" type="text" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].ItemName" type="text" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].Rate" type="number" step="0.01" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].Qty" type="number" step="0.01" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].Discount" type="number" step="0.01" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].TaxPercentage" type="number" step="0.01" class="form-control" /></td>
                    <td><input asp-for="Sale.Details[i].Amount" type="number" step="0.01" class="form-control" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
                </tr>
            }
        </tbody>
    </table>

    <button type="button" id="addRow" class="btn btn-sm btn-secondary mb-2">Add Item</button>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Save Sale</button>
        <a asp-page="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<!-- hidden template row: use __index__ placeholder that we replace -->
<table style="display:none;">
    <tbody>
        <tr id="templateRow">
            <td><input name="Sale.Details[__index__].ItemCode" type="text" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].ItemName" type="text" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].Rate" type="number" step="0.01" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].Qty" type="number" step="0.01" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].Discount" type="number" step="0.01" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].TaxPercentage" type="number" step="0.01" class="form-control" /></td>
            <td><input name="Sale.Details[__index__].Amount" type="number" step="0.01" class="form-control" /></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">Remove</button></td>
        </tr>
    </tbody>
</table>

@section Scripts {
    <script>
        (function () {
            const detailsTbody = document.querySelector('#detailsTable tbody');
            const templateRow = document.getElementById('templateRow');
            // capture innerHTML so we don't duplicate the id when inserting
            const templateInnerHtml = templateRow.innerHTML;

            function reindexRows() {
                const rows = detailsTbody.querySelectorAll('tr');
                rows.forEach((row, idx) => {
                    row.setAttribute('data-index', idx);

                    // update name attributes for inputs/selects/textareas
                    row.querySelectorAll('input, select, textarea').forEach(inp => {
                        // Only operate on elements that have a name (template rows have proper names).
                        const nameAttr = inp.getAttribute('name');
                        if (nameAttr) {
                            // replace any existing index in Sale.Details[...]
                            const newName = nameAttr.replace(/Sale\.Details\[\d+\]/, `Sale.Details[${idx}]`);
                            inp.setAttribute('name', newName);
                        } else {
                            // some server-generated inputs may not have name attr accessible here (rare),
                            // attempt to fix id-based ones by replacing numeric index pattern in id
                            const id = inp.id;
                            if (id) {
                                inp.id = id.replace(/_Details_\d+_/, `_Details_${idx}_`);
                            }
                        }
                    });
                });
            }

            document.getElementById('addRow').addEventListener('click', function () {
                const index = detailsTbody.children.length;
                // create a tr element and set its innerHTML from template (with replaced indices)
                const tr = document.createElement('tr');
                tr.setAttribute('data-index', index);
                tr.innerHTML = templateInnerHtml.replace(/__index__/g, index);
                detailsTbody.appendChild(tr);
            });

            document.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('remove-row')) {
                    const row = e.target.closest('tr');
                    if (row) row.remove();
                    // reindex to ensure indices are contiguous
                    reindexRows();
                }
            });

            // ensure names are correct before submit (safety)
            const form = document.getElementById('saleForm');
            form?.addEventListener('submit', function () {
                reindexRows();
            });

            // initial reindex (in case server-side rows need normalization)
            reindexRows();
        })();
    </script>
}
